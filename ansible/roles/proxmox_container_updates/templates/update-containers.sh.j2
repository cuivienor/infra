#!/bin/bash
# Update all LXC containers with active-use detection
# Managed by Ansible - do not edit manually

set -euo pipefail

LOG_FILE="{{ container_update_config.log_file }}"
LOCK_FILE="{{ container_update_lock_file }}"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

log() {
    echo "[$TIMESTAMP] $1" | tee -a "$LOG_FILE"
}

log_error() {
    echo "[$TIMESTAMP] ERROR: $1" | tee -a "$LOG_FILE" >&2
}

# Check for global lock file (manual override)
if [[ -f "$LOCK_FILE" ]]; then
    log "SKIP ALL: Lock file exists at $LOCK_FILE"
    log "Remove lock file to enable updates: rm $LOCK_FILE"
    exit 0
fi

# Check if container has busy processes
check_container_busy() {
    local ctid=$1
    local status

    status=$(pct status "$ctid" 2>/dev/null | awk '{print $2}')
    if [[ "$status" != "running" ]]; then
        return 1  # Not running, not busy
    fi

    # Check each busy process pattern
{% for check in container_busy_processes %}
    if pct exec "$ctid" -- pgrep -f "{{ check.pattern }}" &>/dev/null; then
        log "SKIP CT$ctid: {{ check.description }} in progress"
        return 0  # Busy
    fi
{% endfor %}

    return 1  # Not busy
}

# Get distro type for container
get_container_distro() {
    local ctid=$1
    if pct exec "$ctid" -- test -f /etc/debian_version 2>/dev/null; then
        echo "debian"
    elif pct exec "$ctid" -- test -f /etc/alpine-release 2>/dev/null; then
        echo "alpine"
    elif pct exec "$ctid" -- test -f /etc/arch-release 2>/dev/null; then
        echo "arch"
    elif pct exec "$ctid" -- test -f /etc/fedora-release 2>/dev/null; then
        echo "fedora"
    else
        echo "unknown"
    fi
}

# Update a single container
update_container() {
    local ctid=$1
    local distro
    local result=0

    distro=$(get_container_distro "$ctid")
    log "Updating CT$ctid ($distro)..."

    case "$distro" in
        debian)
            if ! pct exec "$ctid" -- bash -c "apt-get update && DEBIAN_FRONTEND=noninteractive apt-get dist-upgrade -y && apt-get autoremove -y" 2>&1 | tee -a "$LOG_FILE"; then
                result=1
            fi
            ;;
        alpine)
            if ! pct exec "$ctid" -- apk upgrade --no-cache 2>&1 | tee -a "$LOG_FILE"; then
                result=1
            fi
            ;;
        arch)
            if ! pct exec "$ctid" -- pacman -Syu --noconfirm 2>&1 | tee -a "$LOG_FILE"; then
                result=1
            fi
            ;;
        fedora)
            if ! pct exec "$ctid" -- dnf upgrade -y 2>&1 | tee -a "$LOG_FILE"; then
                result=1
            fi
            ;;
        *)
            log_error "Unknown distro for CT$ctid, skipping"
            result=1
            ;;
    esac

    return $result
}

log "========================================="
log "Container Update Run Started"
log "========================================="

# Get list of all containers
CONTAINERS=$(pct list 2>/dev/null | awk 'NR>1 {print $1}' | sort -n)

if [[ -z "$CONTAINERS" ]]; then
    log "No containers found"
    exit 0
fi

UPDATED=0
SKIPPED=0
FAILED=0

for ctid in $CONTAINERS; do
    log "-----------------------------------------"
    log "Processing CT$ctid..."

    # Check exclusion list
{% if container_update_config.exclude_ctids | length > 0 %}
    if [[ " {{ container_update_config.exclude_ctids | join(' ') }} " =~ " $ctid " ]]; then
        log "SKIP CT$ctid: In exclusion list"
        ((SKIPPED++))
        continue
    fi
{% endif %}

    # Check if busy
    if check_container_busy "$ctid"; then
        ((SKIPPED++))
        continue
    fi

    # Check if running
    status=$(pct status "$ctid" 2>/dev/null | awk '{print $2}')
    was_stopped=false

    if [[ "$status" != "running" ]]; then
{% if container_update_config.auto_start_for_update %}
        log "Starting CT$ctid for update..."
        if pct start "$ctid" 2>&1 | tee -a "$LOG_FILE"; then
            sleep 10  # Wait for container to fully start
            was_stopped=true
        else
            log_error "Failed to start CT$ctid, skipping"
            ((FAILED++))
            continue
        fi
{% else %}
        log "SKIP CT$ctid: Not running (auto_start_for_update=false)"
        ((SKIPPED++))
        continue
{% endif %}
    fi

    # Perform update
    if update_container "$ctid"; then
        log "SUCCESS: CT$ctid updated"
        ((UPDATED++))
    else
        log_error "FAILED: CT$ctid update failed"
        ((FAILED++))
    fi

    # Stop if we started it
    if [[ "$was_stopped" == "true" ]]; then
        log "Stopping CT$ctid (was stopped before update)..."
        pct shutdown "$ctid" --timeout 60 2>&1 | tee -a "$LOG_FILE" || pct stop "$ctid" 2>&1 | tee -a "$LOG_FILE"
    fi
done

log "========================================="
log "Container Update Run Completed"
log "Updated: $UPDATED | Skipped: $SKIPPED | Failed: $FAILED"
log "========================================="

# Exit with error if any failures
if [[ $FAILED -gt 0 ]]; then
    exit 1
fi
