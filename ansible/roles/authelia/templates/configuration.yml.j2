# Authelia Configuration
# Managed by Ansible - DO NOT EDIT MANUALLY

# Default redirection URL (used in password reset emails)
default_redirection_url: '{{ authelia_auth_url }}'

# Server settings
server:
  address: 'tcp://{{ authelia_address }}:{{ authelia_port }}/'

# Logging
log:
  level: 'info'
  format: 'text'

# TOTP Configuration
totp:
  issuer: '{{ authelia_totp_issuer }}'
  period: {{ authelia_totp_period }}
  digits: {{ authelia_totp_digits }}

# Identity validation (for password resets, etc.)
identity_validation:
  reset_password:
    jwt_secret: '{{ authelia_jwt_secret }}'

# Authentication Backend
authentication_backend:
{% if authelia_auth_backend == 'ldap' %}
  # LDAP backend (LLDAP)
  ldap:
    implementation: '{{ authelia_ldap_implementation }}'
    address: '{{ authelia_ldap_address }}'
    base_dn: '{{ authelia_ldap_base_dn }}'
    user: '{{ authelia_ldap_user }}'
    password: '{{ authelia_ldap_password }}'
{% else %}
  # File-based backend
  file:
    path: '{{ authelia_config_dir }}/users.yml'
    password:
      algorithm: 'argon2id'
      iterations: 3
      memory: 64
      parallelism: 4
      key_length: 32
      salt_length: 16
{% endif %}

# Brute-force protection
# Bans users after repeated failed login attempts
regulation:
  max_retries: {{ authelia_regulation_max_retries }}
  find_time: '{{ authelia_regulation_find_time }}'
  ban_time: '{{ authelia_regulation_ban_time }}'

# Access Control
access_control:
  default_policy: '{{ authelia_default_policy }}'
  rules:
{% for rule in authelia_access_rules %}
    - domain: '{{ rule.domain }}'
      policy: '{{ rule.policy }}'
{% if rule.subject is defined %}
      subject:
{% for subj in rule.subject %}
        - '{{ subj }}'
{% endfor %}
{% endif %}
{% endfor %}

# Session Configuration
session:
  secret: '{{ authelia_session_secret }}'
  cookies:
    - domain: '{{ authelia_domain }}'
      authelia_url: '{{ authelia_auth_url }}'
      default_redirection_url: '{{ authelia_default_redirect_url }}'
      name: '{{ authelia_session_name }}'
      expiration: '{{ authelia_session_expiration }}'
      inactivity: '{{ authelia_session_inactivity }}'
      remember_me: '{{ authelia_session_remember_me }}'

# Storage - SQLite
storage:
  encryption_key: '{{ authelia_storage_encryption_key }}'
  local:
    path: '{{ authelia_data_dir }}/db.sqlite3'

# Notifier
notifier:
{% if authelia_notifier_type == 'filesystem' %}
  filesystem:
    filename: '{{ authelia_notifier_filesystem_path }}'
{% elif authelia_notifier_type == 'smtp' %}
  smtp:
    address: '{{ authelia_smtp_address }}'
    username: '{{ authelia_smtp_username }}'
    password: '{{ authelia_smtp_password }}'
    sender: '{{ authelia_smtp_sender }}'
    subject: '{{ authelia_smtp_subject }}'
{% endif %}

{% if authelia_oidc_enabled %}
# OIDC Identity Provider
identity_providers:
  oidc:
    hmac_secret: '{{ authelia_oidc_hmac_secret }}'
    jwks:
      - key_id: 'main'
        algorithm: 'RS256'
        use: 'sig'
        key: |
{{ authelia_oidc_private_key | indent(10, first=true) }}
    clients:
{% for client in authelia_oidc_clients %}
      - client_id: '{{ client.client_id }}'
        client_name: '{{ client.client_name }}'
        client_secret: '{{ client.client_secret }}'
        public: {{ client.public | default(false) | lower }}
        authorization_policy: '{{ client.authorization_policy | default("one_factor") }}'
{% if client.require_pkce | default(false) %}
        require_pkce: true
        pkce_challenge_method: '{{ client.pkce_challenge_method | default("S256") }}'
{% endif %}
        redirect_uris:
{% for uri in client.redirect_uris %}
          - '{{ uri }}'
{% endfor %}
        scopes:
{% for scope in client.scopes %}
          - '{{ scope }}'
{% endfor %}
        userinfo_signed_response_alg: 'none'
        token_endpoint_auth_method: '{{ client.token_endpoint_auth_method | default("client_secret_post") }}'
{% endfor %}
{% endif %}
