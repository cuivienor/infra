---
# Install Node.js and pnpm for wishlist

- name: Install Node.js prerequisites
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - git
      - build-essential  # May be needed for native modules
    state: present
    update_cache: true
  become: true

- name: Create keyrings directory
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: true

- name: Download NodeSource GPG key
  ansible.builtin.get_url:
    url: "https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key"
    dest: /usr/share/keyrings/nodesource.gpg
    mode: '0644'
  become: true

- name: Remove old NodeSource repository entry (if exists)
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/nodesource.asc] https://deb.nodesource.com/node_{{ nodejs_version }}.x nodistro main"
    state: absent
    filename: nodesource
  become: true
  failed_when: false

- name: Add NodeSource repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/nodesource.gpg] https://deb.nodesource.com/node_{{ nodejs_version }}.x nodistro main"
    state: present
    filename: nodesource
  become: true

- name: Install Node.js
  ansible.builtin.apt:
    name: nodejs
    state: present
    update_cache: true
  become: true

- name: Verify Node.js version
  ansible.builtin.command: node --version
  register: node_version_check
  changed_when: false

- name: Display Node.js version
  ansible.builtin.debug:
    msg: "Installed Node.js {{ node_version_check.stdout }}"

- name: Install pnpm via npm
  ansible.builtin.command: npm install -g pnpm
  args:
    creates: /usr/bin/pnpm
  become: true

- name: Verify pnpm version
  ansible.builtin.command: pnpm --version
  register: pnpm_version_check
  changed_when: false

- name: Display pnpm version
  ansible.builtin.debug:
    msg: "Installed pnpm {{ pnpm_version_check.stdout }}"

- name: Create wishlist group
  ansible.builtin.group:
    name: "{{ wishlist_group }}"
    system: true
  become: true

- name: Create wishlist user
  ansible.builtin.user:
    name: "{{ wishlist_user }}"
    group: "{{ wishlist_group }}"
    home: "{{ wishlist_home }}"
    shell: /bin/bash
    system: true
    create_home: true
  become: true

- name: Create wishlist data directory
  ansible.builtin.file:
    path: "{{ wishlist_data_dir }}"
    state: directory
    owner: "{{ wishlist_user }}"
    group: "{{ wishlist_group }}"
    mode: '0755'
  become: true
