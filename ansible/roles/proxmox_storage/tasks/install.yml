---
# Install mergerfs and snapraid packages

- name: Check if mergerfs is installed
  ansible.builtin.command: dpkg -l mergerfs
  register: mergerfs_check
  failed_when: false
  changed_when: false

- name: Install mergerfs from GitHub releases
  block:
    - name: Download mergerfs .deb
      ansible.builtin.get_url:
        url: "https://github.com/trapexit/mergerfs/releases/download/{{ mergerfs_version }}/mergerfs_{{ mergerfs_version }}.debian-bookworm_amd64.deb"
        dest: "/tmp/mergerfs_{{ mergerfs_version }}.deb"
        mode: '0644'

    - name: Install mergerfs package
      ansible.builtin.apt:
        deb: "/tmp/mergerfs_{{ mergerfs_version }}.deb"
        state: present

    - name: Clean up downloaded package
      ansible.builtin.file:
        path: "/tmp/mergerfs_{{ mergerfs_version }}.deb"
        state: absent
  when: mergerfs_check.rc != 0

- name: Check if snapraid is installed
  ansible.builtin.command: which snapraid
  register: snapraid_check
  failed_when: false
  changed_when: false

- name: Install snapraid from GitHub
  block:
    - name: Install build dependencies
      ansible.builtin.apt:
        name:
          - gcc
          - make
        state: present

    - name: Download snapraid source
      ansible.builtin.get_url:
        url: "https://github.com/amadvance/snapraid/releases/download/v{{ snapraid_version }}/snapraid-{{ snapraid_version }}.tar.gz"
        dest: "/tmp/snapraid-{{ snapraid_version }}.tar.gz"
        mode: '0644'

    - name: Extract snapraid source
      ansible.builtin.unarchive:
        src: "/tmp/snapraid-{{ snapraid_version }}.tar.gz"
        dest: /tmp/
        remote_src: true

    - name: Configure snapraid
      ansible.builtin.command: ./configure
      args:
        chdir: "/tmp/snapraid-{{ snapraid_version }}"
        creates: "/tmp/snapraid-{{ snapraid_version }}/Makefile"

    - name: Build snapraid
      ansible.builtin.command: make
      args:
        chdir: "/tmp/snapraid-{{ snapraid_version }}"
        creates: "/tmp/snapraid-{{ snapraid_version }}/snapraid"

    - name: Install snapraid
      ansible.builtin.command: make install
      args:
        chdir: "/tmp/snapraid-{{ snapraid_version }}"
        creates: /usr/local/bin/snapraid

    - name: Clean up build files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "/tmp/snapraid-{{ snapraid_version }}.tar.gz"
        - "/tmp/snapraid-{{ snapraid_version }}"
  when: snapraid_check.rc != 0
