---
# Default variables for restic_backup role

# Restic version to install
restic_version: "0.16.4"
restic_download_url: "https://github.com/restic/restic/releases/download/v{{ restic_version }}/restic_{{ restic_version }}_linux_amd64.bz2"

# Installation paths
restic_bin_path: "/usr/local/bin/restic"
restic_config_dir: "/etc/restic"
restic_cache_dir: "/var/cache/restic"
restic_log_dir: "/var/log/restic"

# Backup user (typically media or root)
backup_user: "media"
backup_group: "media"

# Backup policies configuration
backup_policies:
  # Policy for /mnt/storage data (excludes large media files)
  # Backs up: photos, documents, backups from archives/
  # Excludes: All media/, private/, google-takeout/
  - name: "data"
    enabled: true
    paths:
      - "/mnt/storage"
    excludes:
      # Large media directories (expensive to backup, can be re-ripped/re-downloaded)
      # Note: media/ includes movies, tv, audiobooks, e-books, staging, legacy-media
      - "/mnt/storage/media/**"

      # Private content (adult content, not backed up)
      - "/mnt/storage/private/**"

      # Google Takeout (Google Photos archive - 598GB, not backing up)
      - "/mnt/storage/google-takeout/**"

      # Old Photos directory (pending deletion after consolidation verified)
      - "/mnt/storage/Photos-OLD-DELETE-AFTER-REVIEW/**"

      # Temporary/cache directories
      - "/mnt/storage/temp/**"
      - "/mnt/storage/lost+found/**"
      - "/mnt/storage/.snapraid.*"

      # Common patterns to skip
      - "**/.Trash-*/**"
      - "**/Thumbs.db"
      - "**/.DS_Store"
      - "**/*.tmp"
      - "**/*.partial"
      - "**/node_modules/**"
      - "**/__pycache__/**"
    schedule: "daily"
    retention:
      keep_daily: 7
      keep_weekly: 4
      keep_monthly: 6
      keep_yearly: 2
    b2_bucket: "{{ b2_bucket_data }}"

# Backblaze B2 configuration (sensitive values in vault)
b2_account_id: "{{ vault_b2_account_id }}"
b2_account_key: "{{ vault_b2_account_key }}"
b2_bucket_data: "{{ vault_b2_bucket_data | default('homelab-data') }}"

# Restic repository passwords (sensitive values in vault)
restic_password_data: "{{ vault_restic_password_data }}"

# Performance settings
restic_nice_level: 19  # Run backups with low priority
restic_ionice_class: "idle"  # Use idle I/O priority

# Notification settings (optional)
backup_notify_email: ""
backup_notify_on_success: false
backup_notify_on_failure: true

# Backup check settings
backup_check_enabled: true
backup_check_schedule: "weekly"  # Run 'restic check' weekly

# Pre/post backup hooks
backup_pre_hook: ""
backup_post_hook: ""

# ============================================
# Service container backup sync configuration
# ============================================
# These containers have their data synced to /mnt/storage/backups/
# before the Restic backup runs, preserving SSD performance.

backup_sync_enabled: false  # Set to true to enable pre-backup sync from containers

backup_sync_targets:
  # LLDAP - User directory (SQLite + private key)
  - name: lldap
    host: 192.168.1.114
    enabled: true
    paths:
      - /var/lib/lldap/
      - /opt/lldap/lldap_config.toml

  # Authelia - SSO (SQLite + config with OIDC key)
  - name: authelia
    host: 192.168.1.112
    enabled: true
    paths:
      - /var/lib/authelia/
      - /etc/authelia/

  # Mealie - Recipes (PostgreSQL + data + env)
  - name: mealie
    host: 192.168.1.187
    enabled: true
    pre_command: "sudo -u postgres pg_dump mealie > /tmp/mealie_backup.sql"
    paths:
      - /opt/mealie/data/
      - /opt/mealie/.env
    extra_paths:
      - /tmp/mealie_backup.sql

  # Wishlist - Gift registry (SQLite + uploads)
  - name: wishlist
    host: 192.168.1.186
    enabled: true
    paths:
      - /opt/wishlist/data/
      - /opt/wishlist/uploads/

  # Jellyfin - Media server (library metadata, config - NOT cache)
  - name: jellyfin
    host: 192.168.1.130
    enabled: true
    paths:
      - /var/lib/jellyfin/
      - /etc/jellyfin/
    excludes:
      - "*.cache*"
      - "transcodes/"

  # Caddy - Reverse proxy (TLS certs + config + API token)
  - name: caddy
    host: 192.168.1.111
    enabled: true
    paths:
      - /var/lib/caddy/.local/share/caddy/
      - /etc/caddy/
      - /etc/default/caddy

  # Vault/CouchDB - Family notes (database + config)
  - name: vault
    host: 192.168.1.150
    enabled: true
    paths:
      - /var/lib/couchdb/
      - /opt/couchdb/etc/local.d/
