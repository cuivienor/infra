---
# SSH key setup for backup container to access service containers

- name: Create .ssh directory for root
  ansible.builtin.file:
    path: /root/.ssh
    state: directory
    mode: '0700'
    owner: root
    group: root

- name: Generate SSH key pair for backup container
  community.crypto.openssh_keypair:
    path: /root/.ssh/id_ed25519
    type: ed25519
    comment: "backup-container-rsync"
    mode: '0600'
  register: backup_ssh_key

- name: Read the generated public key
  ansible.builtin.slurp:
    src: /root/.ssh/id_ed25519.pub
  register: backup_ssh_pubkey_content

- name: Display backup SSH public key
  ansible.builtin.debug:
    msg: |
      Backup container SSH public key:
      {{ backup_ssh_pubkey_content.content | b64decode }}

      Add this to your playbook vars as 'backup_ssh_pubkey' to distribute to service containers.

- name: Save public key to known location for reference
  ansible.builtin.copy:
    content: "{{ backup_ssh_pubkey_content.content | b64decode }}"
    dest: "{{ restic_config_dir }}/backup_ssh_pubkey"
    mode: '0644'

- name: Configure SSH client for service containers
  ansible.builtin.copy:
    content: |
      # SSH config for backup rsync to service containers
      # Generated by Ansible - DO NOT EDIT MANUALLY

      Host *
        StrictHostKeyChecking no
        UserKnownHostsFile /dev/null
        BatchMode yes
        ConnectTimeout 10
        IdentityFile /root/.ssh/id_ed25519
    dest: /root/.ssh/config
    mode: '0600'
    owner: root
    group: root
