---
# Create systemd units for automated backups

- name: Create systemd service files for each backup policy
  ansible.builtin.template:
    src: backup.service.j2
    dest: "/etc/systemd/system/restic-backup-{{ item.name }}.service"
    mode: '0644'
    owner: root
    group: root
  loop: "{{ backup_policies }}"
  when: item.enabled | default(false)
  notify: Reload systemd

- name: Create systemd timer files for each backup policy
  ansible.builtin.template:
    src: backup.timer.j2
    dest: "/etc/systemd/system/restic-backup-{{ item.name }}.timer"
    mode: '0644'
    owner: root
    group: root
  loop: "{{ backup_policies }}"
  when: item.enabled | default(false)
  notify: Reload systemd

- name: Create systemd service for backup checks
  ansible.builtin.template:
    src: check.service.j2
    dest: "/etc/systemd/system/restic-check.service"
    mode: '0644'
    owner: root
    group: root
  when: backup_check_enabled
  notify: Reload systemd

- name: Create systemd timer for backup checks
  ansible.builtin.template:
    src: check.timer.j2
    dest: "/etc/systemd/system/restic-check.timer"
    mode: '0644'
    owner: root
    group: root
  when: backup_check_enabled
  notify: Reload systemd

- name: Force systemd reload
  ansible.builtin.meta: flush_handlers

- name: Enable and start backup timers
  ansible.builtin.systemd:
    name: "restic-backup-{{ item.name }}.timer"
    enabled: true
    state: started
    daemon_reload: true
  loop: "{{ backup_policies }}"
  when: item.enabled | default(false)

- name: Enable and start check timer
  ansible.builtin.systemd:
    name: restic-check.timer
    enabled: true
    state: started
    daemon_reload: true
  when: backup_check_enabled
