#!/bin/bash
# Restic maintenance and check script
# Generated by Ansible - DO NOT EDIT MANUALLY

set -euo pipefail

ACTION="${1:-check}"
POLICY="${2:-all}"

LOG_FILE="{{ restic_log_dir }}/maintenance-$(date +%Y%m%d-%H%M%S).log"
exec 1> >(tee -a "$LOG_FILE")
exec 2>&1

echo "========================================="
echo "Restic Maintenance - $ACTION"
echo "Started: $(date)"
echo "========================================="

# Function to run command for all policies
run_for_policies() {
    local cmd=$1
    local policies=()
    
    if [ "$POLICY" = "all" ]; then
        {% for policy in backup_policies %}
        {% if policy.enabled | default(false) %}
        policies+=("{{ policy.name }}")
        {% endif %}
        {% endfor %}
    else
        policies=("$POLICY")
    fi
    
    for policy in "${policies[@]}"; do
        echo "----------------------------------------"
        echo "Processing policy: $policy"
        echo "----------------------------------------"
        
        source {{ restic_config_dir }}/${policy}.env
        
        eval "$cmd" || {
            echo "ERROR: Command failed for policy $policy"
            continue
        }
    done
}

case "$ACTION" in
    check)
        echo "Running repository integrity check..."
        run_for_policies "{{ restic_bin_path }} check --read-data-subset=5%"
        ;;
        
    stats)
        echo "Gathering repository statistics..."
        run_for_policies "{{ restic_bin_path }} stats --mode=restore-size"
        ;;
        
    snapshots)
        echo "Listing snapshots..."
        run_for_policies "{{ restic_bin_path }} snapshots"
        ;;
        
    unlock)
        echo "Unlocking repositories (removes stale locks)..."
        run_for_policies "{{ restic_bin_path }} unlock"
        ;;
        
    prune)
        echo "Pruning old data (manual trigger)..."
        run_for_policies "{{ restic_bin_path }} prune"
        ;;
        
    *)
        echo "Usage: $0 {check|stats|snapshots|unlock|prune} [policy_name|all]"
        echo ""
        echo "Available policies:"
        {% for policy in backup_policies %}
        {% if policy.enabled | default(false) %}
        echo "  - {{ policy.name }}"
        {% endif %}
        {% endfor %}
        exit 1
        ;;
esac

echo "========================================="
echo "Finished: $(date)"
echo "Log: $LOG_FILE"
echo "========================================="
