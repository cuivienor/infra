#!/bin/bash
# Restic restore script
# Generated by Ansible - DO NOT EDIT MANUALLY

set -euo pipefail

# Default values
POLICY=""
SNAPSHOT="latest"
RESTORE_PATH=""
TARGET_PATH=""

# Usage information
usage() {
    cat << EOF
Usage: $0 -p POLICY -t TARGET_PATH [-s SNAPSHOT] [-r RESTORE_PATH]

Restore files from restic backup.

Required:
  -p POLICY         Backup policy name (sensitive, staging, library)
  -t TARGET_PATH    Where to restore files to

Optional:
  -s SNAPSHOT       Snapshot ID or 'latest' (default: latest)
  -r RESTORE_PATH   Specific path within backup to restore (default: entire backup)
  -h                Show this help message

Examples:
  # Restore latest sensitive backup to /tmp/restore
  $0 -p sensitive -t /tmp/restore

  # Restore specific snapshot
  $0 -p sensitive -s abc123def -t /tmp/restore

  # Restore specific directory from backup
  $0 -p staging -t /tmp/restore -r /mnt/storage/media/staging/1-ripped

  # List available snapshots
  source {{ restic_config_dir }}/sensitive.env && {{ restic_bin_path }} snapshots

Available policies:
{% for policy in backup_policies %}
{% if policy.enabled | default(false) %}
  - {{ policy.name }}
{% endif %}
{% endfor %}

EOF
    exit 1
}

# Parse arguments
while getopts "p:s:r:t:h" opt; do
    case $opt in
        p) POLICY="$OPTARG" ;;
        s) SNAPSHOT="$OPTARG" ;;
        r) RESTORE_PATH="$OPTARG" ;;
        t) TARGET_PATH="$OPTARG" ;;
        h) usage ;;
        *) usage ;;
    esac
done

# Validate required arguments
if [ -z "$POLICY" ] || [ -z "$TARGET_PATH" ]; then
    echo "ERROR: Missing required arguments"
    usage
fi

# Validate policy exists
ENV_FILE="{{ restic_config_dir }}/${POLICY}.env"
if [ ! -f "$ENV_FILE" ]; then
    echo "ERROR: Policy '$POLICY' not found"
    echo "Environment file does not exist: $ENV_FILE"
    exit 1
fi

# Load environment
source "$ENV_FILE"

# Create target directory if it doesn't exist
mkdir -p "$TARGET_PATH"

# Build restore command
RESTORE_CMD="{{ restic_bin_path }} restore $SNAPSHOT --target $TARGET_PATH"

# Add specific path if requested
if [ -n "$RESTORE_PATH" ]; then
    RESTORE_CMD="$RESTORE_CMD --include $RESTORE_PATH"
fi

# Log
LOG_FILE="{{ restic_log_dir }}/restore-${POLICY}-$(date +%Y%m%d-%H%M%S).log"
exec 1> >(tee -a "$LOG_FILE")
exec 2>&1

echo "========================================="
echo "Restic Restore"
echo "Policy: $POLICY"
echo "Snapshot: $SNAPSHOT"
echo "Target: $TARGET_PATH"
[ -n "$RESTORE_PATH" ] && echo "Restore path: $RESTORE_PATH"
echo "Started: $(date)"
echo "========================================="

# Show snapshot info
echo "Snapshot information:"
{{ restic_bin_path }} snapshots "$SNAPSHOT" || {
    echo "ERROR: Snapshot not found. Listing available snapshots:"
    {{ restic_bin_path }} snapshots
    exit 1
}

# Confirm restore
echo ""
echo "WARNING: This will restore files to $TARGET_PATH"
read -p "Continue? (yes/no): " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
    echo "Restore cancelled"
    exit 0
fi

# Run restore
echo ""
echo "Starting restore..."
$RESTORE_CMD

RESTORE_EXIT=$?

echo "========================================="
echo "Finished: $(date)"
echo "Exit code: $RESTORE_EXIT"
echo "Log: $LOG_FILE"
echo "========================================="

if [ $RESTORE_EXIT -eq 0 ]; then
    echo "Restore completed successfully"
    echo "Files are in: $TARGET_PATH"
else
    echo "ERROR: Restore failed"
fi

exit $RESTORE_EXIT
