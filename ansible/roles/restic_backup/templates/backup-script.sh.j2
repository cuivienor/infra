#!/bin/bash
# Restic backup script for {{ item.name }} policy
# Generated by Ansible - DO NOT EDIT MANUALLY

set -euo pipefail

# Load environment
source {{ restic_config_dir }}/{{ item.name }}.env

# Logging
LOG_FILE="{{ restic_log_dir }}/backup-{{ item.name }}-$(date +%Y%m%d-%H%M%S).log"
exec 1> >(tee -a "$LOG_FILE")
exec 2>&1

echo "========================================="
echo "Restic Backup - {{ item.name }} policy"
echo "Started: $(date)"
echo "========================================="

# Pre-backup hook
{% if backup_pre_hook %}
echo "Running pre-backup hook..."
{{ backup_pre_hook }}
{% endif %}

# Build backup command
BACKUP_CMD="{{ restic_bin_path }} backup"

# Add paths
{% for path in item.paths %}
BACKUP_CMD="$BACKUP_CMD {{ path }}"
{% endfor %}

# Add excludes file if exists
{% if item.excludes | default([]) | length > 0 %}
BACKUP_CMD="$BACKUP_CMD --exclude-file={{ restic_config_dir }}/{{ item.name }}-excludes.txt"
{% endif %}

# Add common excludes
BACKUP_CMD="$BACKUP_CMD --exclude-caches --exclude-if-present .nobackup"

# Add tags
BACKUP_CMD="$BACKUP_CMD --tag {{ item.name }} --tag automated"

# Add progress and stats
BACKUP_CMD="$BACKUP_CMD --verbose=1"

# Run backup with nice/ionice
echo "Starting backup..."
nice -n {{ restic_nice_level }} ionice -c {{ restic_ionice_class }} $BACKUP_CMD

BACKUP_EXIT=$?

if [ $BACKUP_EXIT -eq 0 ]; then
    echo "Backup completed successfully"
    
    # Prune old backups
    echo "Pruning old snapshots..."
    {{ restic_bin_path }} forget \
        --tag {{ item.name }} \
        --keep-daily {{ item.retention.keep_daily }} \
        --keep-weekly {{ item.retention.keep_weekly }} \
        --keep-monthly {{ item.retention.keep_monthly }} \
        --keep-yearly {{ item.retention.keep_yearly }} \
        --prune \
        --verbose=1
    
    PRUNE_EXIT=$?
    
    if [ $PRUNE_EXIT -eq 0 ]; then
        echo "Prune completed successfully"
    else
        echo "WARNING: Prune failed with exit code $PRUNE_EXIT"
    fi
else
    echo "ERROR: Backup failed with exit code $BACKUP_EXIT"
fi

# Post-backup hook
{% if backup_post_hook %}
echo "Running post-backup hook..."
{{ backup_post_hook }}
{% endif %}

echo "========================================="
echo "Finished: $(date)"
echo "Log: $LOG_FILE"
echo "========================================="

# Keep only last 30 days of logs
find {{ restic_log_dir }} -name "backup-{{ item.name }}-*.log" -mtime +30 -delete

exit $BACKUP_EXIT
