#!/bin/bash
# Pre-backup sync script - pulls data from service containers
# Generated by Ansible - DO NOT EDIT MANUALLY

set -euo pipefail

BACKUP_DIR="/mnt/storage/backups"
LOG_FILE="{{ restic_log_dir }}/pre-backup-sync-$(date +%Y%m%d-%H%M%S).log"

# SSH options for non-interactive rsync
SSH_OPTS="-o StrictHostKeyChecking=no -o BatchMode=yes -o ConnectTimeout=10"

exec 1> >(tee -a "$LOG_FILE")
exec 2>&1

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"
}

sync_paths() {
    local name="$1"
    local host="$2"
    shift 2
    local paths=("$@")

    log "Syncing $name from $host"
    mkdir -p "$BACKUP_DIR/$name"

    for path in "${paths[@]}"; do
        if [[ -n "$path" ]]; then
            log "  - $path"
            rsync -az --delete -e "ssh $SSH_OPTS" "root@$host:$path" "$BACKUP_DIR/$name/" || {
                log "WARNING: Failed to sync $path from $host"
            }
        fi
    done
}

log "========================================="
log "Pre-backup sync started"
log "========================================="

# Ensure backup directory exists
mkdir -p "$BACKUP_DIR"

{% for target in backup_sync_targets %}
{% if target.enabled | default(true) %}
# {{ target.name | upper }}
{% if target.pre_command is defined %}
log "Running pre-sync command for {{ target.name }}"
ssh $SSH_OPTS root@{{ target.host }} "{{ target.pre_command }}" || log "WARNING: Pre-command failed for {{ target.name }}"
{% endif %}
log "Syncing {{ target.name }}"
mkdir -p "$BACKUP_DIR/{{ target.name }}"
{% for path in target.paths %}
{% if target.excludes is defined and target.excludes | length > 0 %}
rsync -az --delete{% for exc in target.excludes %} --exclude='{{ exc }}'{% endfor %} -e "ssh $SSH_OPTS" "root@{{ target.host }}:{{ path }}" "$BACKUP_DIR/{{ target.name }}/" || log "WARNING: Failed to sync {{ path }}"
{% else %}
rsync -az --delete -e "ssh $SSH_OPTS" "root@{{ target.host }}:{{ path }}" "$BACKUP_DIR/{{ target.name }}/" || log "WARNING: Failed to sync {{ path }}"
{% endif %}
{% endfor %}
{% if target.extra_paths is defined %}
{% for path in target.extra_paths %}
rsync -az --delete -e "ssh $SSH_OPTS" "root@{{ target.host }}:{{ path }}" "$BACKUP_DIR/{{ target.name }}/" || log "WARNING: Failed to sync {{ path }}"
{% endfor %}
{% endif %}

{% endif %}
{% endfor %}

log "========================================="
log "Pre-backup sync completed"
log "========================================="

# Keep only last 30 days of sync logs
find {{ restic_log_dir }} -name "pre-backup-sync-*.log" -mtime +30 -delete 2>/dev/null || true
