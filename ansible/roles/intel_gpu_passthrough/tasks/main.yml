---
# Intel GPU passthrough configuration for LXC containers
# This role must run on the Proxmox host (delegate_to: homelab)

- name: Verify container_id is defined
  ansible.builtin.assert:
    that:
      - container_id is defined
      - container_id is number
    fail_msg: "container_id must be defined and numeric"

- name: Check if GPU devices exist on host
  ansible.builtin.stat:
    path: "{{ item }}"
  loop:
    - "{{ intel_gpu_card_device }}"
    - "{{ intel_gpu_render_device }}"
  register: gpu_devices_stat
  delegate_to: homelab

- name: Fail if GPU devices not found
  ansible.builtin.fail:
    msg: "GPU device {{ item.item }} not found on host"
  when: not item.stat.exists
  loop: "{{ gpu_devices_stat.results }}"

- name: Get current LXC configuration
  ansible.builtin.slurp:
    path: "/etc/pve/lxc/{{ container_id }}.conf"
  register: lxc_config_current
  delegate_to: homelab

- name: Parse current configuration
  ansible.builtin.set_fact:
    lxc_config_content: "{{ lxc_config_current.content | b64decode }}"

- name: Check if GPU passthrough already configured
  ansible.builtin.set_fact:
    gpu_passthrough_configured: "{{ 'lxc.cgroup2.devices.allow: c 226:1 rwm' in lxc_config_content }}"

- name: Add cgroup device permissions for card1
  ansible.builtin.lineinfile:
    path: "/etc/pve/lxc/{{ container_id }}.conf"
    line: "lxc.cgroup2.devices.allow: c {{ intel_gpu_major }}:{{ intel_gpu_card_minor }} rwm"
    state: present
  when: not gpu_passthrough_configured
  delegate_to: homelab
  notify: Restart container

- name: Add cgroup device permissions for renderD128
  ansible.builtin.lineinfile:
    path: "/etc/pve/lxc/{{ container_id }}.conf"
    line: "lxc.cgroup2.devices.allow: c {{ intel_gpu_major }}:{{ intel_gpu_render_minor }} rwm"
    state: present
  when: not gpu_passthrough_configured
  delegate_to: homelab
  notify: Restart container

- name: Add mount entry for /dev/dri directory
  ansible.builtin.lineinfile:
    path: "/etc/pve/lxc/{{ container_id }}.conf"
    line: "lxc.mount.entry: /dev/dri dev/dri none bind,optional,create=dir"
    state: present
  when: not gpu_passthrough_configured
  delegate_to: homelab
  notify: Restart container

- name: Display configuration status
  ansible.builtin.debug:
    msg: "Intel GPU passthrough {{ 'already configured' if gpu_passthrough_configured else 'configured (container restart required)' }}"
