---
# Deploy Mealie application

- name: Get latest Mealie release version
  ansible.builtin.uri:
    url: https://api.github.com/repos/mealie-recipes/mealie/releases/latest
    return_content: true
  register: mealie_release
  when: mealie_version == "latest"

- name: Set Mealie version
  ansible.builtin.set_fact:
    mealie_actual_version: "{{ mealie_release.json.tag_name | default(mealie_version) }}"

- name: Download Mealie release
  ansible.builtin.unarchive:
    src: "https://github.com/mealie-recipes/mealie/archive/refs/tags/{{ mealie_actual_version }}.tar.gz"
    dest: "{{ mealie_home }}"
    remote_src: true
    owner: "{{ mealie_user }}"
    group: "{{ mealie_group }}"
    extra_opts:
      - --strip-components=1
  become: true
  notify: Restart mealie

- name: Install Python 3.12 with uv
  ansible.builtin.command:
    cmd: uv python install 3.12
  become: true
  register: uv_python_install
  changed_when: "'Installed' in uv_python_install.stderr"

- name: Check Python version in venv
  ansible.builtin.shell: |
    {{ mealie_home }}/venv/bin/python --version 2>&1 | grep -q "3.12"
  args:
    executable: /bin/bash
  register: venv_python_check
  failed_when: false
  changed_when: false
  become: true
  become_user: "{{ mealie_user }}"

- name: Remove old venv if not Python 3.12
  ansible.builtin.file:
    path: "{{ mealie_home }}/venv"
    state: absent
  when: venv_python_check.rc != 0
  become: true

- name: Create Python virtual environment with Python 3.12
  ansible.builtin.shell: |
    cd {{ mealie_home }}
    uv venv --python 3.12 venv
  args:
    executable: /bin/bash
    creates: "{{ mealie_home }}/venv/bin/python3.12"
  become: true
  become_user: "{{ mealie_user }}"

- name: Install Python dependencies from pyproject.toml
  ansible.builtin.shell: |
    cd {{ mealie_home }}
    source venv/bin/activate
    uv pip install .
  args:
    executable: /bin/bash
  become: true
  become_user: "{{ mealie_user }}"
  changed_when: true

- name: Install additional Python packages for PostgreSQL
  ansible.builtin.shell: |
    cd {{ mealie_home }}
    source venv/bin/activate
    uv pip install psycopg2-binary
  args:
    executable: /bin/bash
  become: true
  become_user: "{{ mealie_user }}"
  changed_when: true

# Extract prebuilt frontend from Docker image (avoids memory-intensive yarn build)
- name: Install skopeo for Docker image extraction
  ansible.builtin.apt:
    name: skopeo
    state: present
  become: true

- name: Create temp directory for Docker image extraction
  ansible.builtin.file:
    path: /tmp/mealie-docker
    state: directory
    mode: '0755'
  become: true

- name: Download Mealie Docker image layers
  ansible.builtin.shell: |
    cd /tmp/mealie-docker
    skopeo copy docker://ghcr.io/mealie-recipes/mealie:{{ mealie_actual_version }} dir:mealie-image
  args:
    executable: /bin/bash
    creates: /tmp/mealie-docker/mealie-image/manifest.json
  become: true

- name: Extract frontend from Docker image layers
  ansible.builtin.shell: |
    cd /tmp/mealie-docker/mealie-image
    # Find the largest blob (contains the application) and extract frontend
    largest_blob=$(ls -S | grep -v manifest | grep -v version | head -1)
    if [ -n "$largest_blob" ]; then
      gunzip -c "$largest_blob" 2>/dev/null | tar -xf - -C /tmp/mealie-docker opt/mealie/lib/python3.12/site-packages/mealie/frontend 2>/dev/null || true
    fi
  args:
    executable: /bin/bash
    creates: /tmp/mealie-docker/opt/mealie/lib/python3.12/site-packages/mealie/frontend/200.html
  become: true

- name: Ensure mealie frontend directory exists
  ansible.builtin.file:
    path: "{{ mealie_home }}/mealie/frontend"
    state: directory
    owner: "{{ mealie_user }}"
    group: "{{ mealie_group }}"
    mode: '0755'
  become: true

- name: Copy extracted frontend to mealie
  ansible.builtin.shell: |
    if [ -d /tmp/mealie-docker/opt/mealie/lib/python3.12/site-packages/mealie/frontend ]; then
      cp -r /tmp/mealie-docker/opt/mealie/lib/python3.12/site-packages/mealie/frontend/* {{ mealie_home }}/mealie/frontend/
      chown -R {{ mealie_user }}:{{ mealie_group }} {{ mealie_home }}/mealie/frontend/
    fi
  args:
    executable: /bin/bash
  become: true
  changed_when: true

- name: Clean up Docker image extraction
  ansible.builtin.file:
    path: /tmp/mealie-docker
    state: absent
  become: true

- name: Download NLTK data
  ansible.builtin.shell: |
    cd {{ mealie_home }}
    source venv/bin/activate
    python -m nltk.downloader -d {{ mealie_home }}/nltk_data averaged_perceptron_tagger_eng punkt_tab
  args:
    executable: /bin/bash
    creates: "{{ mealie_home }}/nltk_data"
  become: true
  become_user: "{{ mealie_user }}"

- name: Deploy environment file
  ansible.builtin.template:
    src: mealie.env.j2
    dest: "{{ mealie_home }}/.env"
    owner: "{{ mealie_user }}"
    group: "{{ mealie_group }}"
    mode: '0600'
  become: true
  notify: Restart mealie
