---
# Samba installation and configuration tasks

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  tags: [samba, install]

- name: Install Samba packages
  ansible.builtin.apt:
    name:
      - samba
      - samba-common-bin
      - cifs-utils  # Useful for testing
    state: present
  tags: [samba, install]

- name: Ensure media group exists
  ansible.builtin.group:
    name: media
    gid: 1000
    state: present
  tags: [samba, users]

- name: Ensure media user exists
  ansible.builtin.user:
    name: media
    uid: 1000
    group: media
    groups: []
    shell: /bin/bash
    create_home: true
    home: /home/media
    state: present
  tags: [samba, users]

- name: Ensure /mnt/storage exists and has correct permissions
  ansible.builtin.file:
    path: /mnt/storage
    state: directory
    owner: media
    group: media
    mode: '0775'
  tags: [samba, permissions]

- name: Deploy Samba configuration
  ansible.builtin.template:
    src: smb.conf.j2
    dest: /etc/samba/smb.conf
    owner: root
    group: root
    mode: '0644'
    validate: 'testparm -s %s'
  notify: Restart samba
  tags: [samba, config]

- name: Check if media user exists in Samba
  ansible.builtin.shell: pdbedit -L | grep -q '^media:'
  register: samba_user_exists
  changed_when: false
  failed_when: false
  tags: [samba, users]

- name: Set Samba password for media user
  ansible.builtin.shell: |
    (echo "{{ samba_media_password }}"; echo "{{ samba_media_password }}") | smbpasswd -a -s media
  when: samba_user_exists.rc != 0
  no_log: true  # Don't log password
  tags: [samba, users]

- name: Enable media user in Samba
  ansible.builtin.shell: smbpasswd -e media
  changed_when: false
  tags: [samba, users]

- name: Create systemd override directory for Samba services
  ansible.builtin.file:
    path: "/etc/systemd/system/{{ item }}.service.d"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - smbd
    - nmbd
  tags: [samba, service]

- name: Configure Samba service restart policy
  ansible.builtin.copy:
    dest: "/etc/systemd/system/{{ item }}.service.d/override.conf"
    content: |
      # Managed by Ansible - automatic restart on failure
      [Service]
      Restart=on-failure
      RestartSec=10s
      StartLimitBurst=5
      StartLimitIntervalSec=300s
    owner: root
    group: root
    mode: '0644'
  loop:
    - smbd
    - nmbd
  notify: Reload systemd and restart samba
  tags: [samba, service]

- name: Ensure Samba services are enabled and started
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: started
  loop:
    - smbd
    - nmbd
  tags: [samba, service]

- name: Create Samba log directory
  ansible.builtin.file:
    path: /var/log/samba
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags: [samba, logging]
