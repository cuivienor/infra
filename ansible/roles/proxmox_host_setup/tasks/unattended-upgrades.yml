---
# Configure automatic security updates for Proxmox host
# Uses unattended-upgrades package (Debian standard)

- name: Install unattended-upgrades packages
  ansible.builtin.apt:
    name:
      - unattended-upgrades
      - apt-listchanges
      - needrestart
    state: present
    update_cache: true
    cache_valid_time: 3600

- name: Configure unattended-upgrades
  ansible.builtin.template:
    src: 50unattended-upgrades.j2
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    owner: root
    group: root
    mode: '0644'
  notify: Reload systemd

- name: Enable automatic updates
  ansible.builtin.template:
    src: 20auto-upgrades.j2
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    owner: root
    group: root
    mode: '0644'

- name: Configure needrestart to be non-interactive
  ansible.builtin.lineinfile:
    path: /etc/needrestart/needrestart.conf
    regexp: '^#?\$nrconf\{restart\}'
    line: "$nrconf{restart} = 'a';"
    create: false
  failed_when: false  # File may not exist on all systems

- name: Ensure log directory exists
  ansible.builtin.file:
    path: "{{ pve_auto_updates_log_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Run initial dry-run to verify configuration
  ansible.builtin.command: unattended-upgrade --dry-run --debug
  register: dry_run_result
  changed_when: false
  failed_when: false

- name: Display dry-run summary
  ansible.builtin.debug:
    msg: |
      Unattended-upgrades configured successfully.

      Settings:
      - Security updates only: {{ pve_auto_updates_security_only }}
      - Auto-reboot: {{ pve_auto_updates_reboot }}
      - Email notifications: {{ pve_auto_updates_mail_to | default('disabled', true) }}
      - Remove unused packages: {{ pve_auto_updates_remove_unused }}
      - Log directory: {{ pve_auto_updates_log_dir }}

      Dry-run status: {{ 'OK' if dry_run_result.rc == 0 else 'Check logs' }}

      Updates will run automatically (typically daily via apt timer).
      Check status: systemctl status apt-daily-upgrade.timer
      View logs: ls -la {{ pve_auto_updates_log_dir }}/
