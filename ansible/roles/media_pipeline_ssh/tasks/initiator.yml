---
# Configure this host to initiate SSH connections to other media containers

- name: Ensure media user .ssh directory exists
  ansible.builtin.file:
    path: /home/media/.ssh
    state: directory
    mode: '0700'
    owner: media
    group: media

- name: Deploy media-pipeline private key
  ansible.builtin.copy:
    content: "{{ media_pipeline_ssh_private_key }}"
    dest: /home/media/.ssh/id_ed25519
    mode: '0600'
    owner: media
    group: media
  no_log: true

- name: Check which hosts are already in known_hosts
  ansible.builtin.command: ssh-keygen -F {{ item }}
  args:
    chdir: /home/media
  loop: "{{ media_pipeline_ssh_targets }}"
  register: known_hosts_check
  failed_when: false
  changed_when: false
  become_user: media

- name: Scan and add missing target host keys to known_hosts
  ansible.builtin.shell: |
    ssh-keyscan -H {{ item.item }} >> /home/media/.ssh/known_hosts 2>/dev/null
  loop: "{{ known_hosts_check.results }}"
  loop_control:
    label: "{{ item.item }}"
  when: item.rc != 0
  become_user: media

- name: Ensure known_hosts has correct permissions
  ansible.builtin.file:
    path: /home/media/.ssh/known_hosts
    mode: '0644'
    owner: media
    group: media
  when: media_pipeline_ssh_targets | length > 0
