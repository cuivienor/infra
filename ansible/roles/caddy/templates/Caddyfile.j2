# Caddyfile - Managed by Ansible
# DO NOT EDIT MANUALLY

{
    # Global options
    email {{ caddy_acme_email }}

{% if caddy_acme_staging %}
    # Using Let's Encrypt staging environment (test certificates)
    # Remove this block for production certificates
    acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
{% endif %}
}

# Reverse proxy configurations
{% for target in caddy_proxy_targets %}
{{ target.domain }} {
{% if authelia_enabled | default(false) and target.authelia_protected | default(false) %}
    # Forward authentication to Authelia
    forward_auth {{ authelia_address }} {
        uri /api/authz/forward-auth
        copy_headers Remote-User Remote-Groups Remote-Email Remote-Name
    }

{% endif %}
{% if target.upstream_https | default(false) %}
    reverse_proxy https://{{ target.upstream }} {
        transport http {
            tls_insecure_skip_verify
        }
    }
{% else %}
    reverse_proxy {{ target.upstream }}
{% endif %}

    tls {
        dns cloudflare {env.CLOUDFLARE_API_TOKEN}
    }
}

{% endfor %}
{% if caddy_proxy_targets | length == 0 %}
# No proxy targets configured yet
# Add targets via caddy_proxy_targets variable
{% endif %}
