---
# SSH server hardening tasks

- name: Configure SSH - Disable password authentication
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PasswordAuthentication'
    line: "PasswordAuthentication {{ sshd_password_authentication }}"
    state: present
  notify: Restart sshd

- name: Configure SSH - Enable public key authentication
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PubkeyAuthentication'
    line: "PubkeyAuthentication {{ sshd_pubkey_authentication }}"
    state: present
  notify: Restart sshd

- name: Configure SSH - Root login policy
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitRootLogin'
    line: "PermitRootLogin {{ sshd_permit_root_login }}"
    state: present
  notify: Restart sshd

- name: Configure SSH - Disable empty passwords
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitEmptyPasswords'
    line: "PermitEmptyPasswords no"
    state: present
  notify: Restart sshd

- name: Configure SSH - Use protocol 2 only (if not already default)
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?Protocol'
    line: "Protocol 2"
    state: present
  notify: Restart sshd
  ignore_errors: yes  # Protocol directive removed in newer SSH versions
