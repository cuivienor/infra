---
# System configuration tasks

- name: Set timezone
  community.general.timezone:
    name: "{{ timezone }}"

- name: Generate locale
  community.general.locale_gen:
    name: "{{ locale }}"
    state: present
  when: locale is defined

- name: Set system locale
  ansible.builtin.copy:
    content: |
      LANG={{ locale }}
      LC_ALL={{ locale }}
    dest: /etc/default/locale
    mode: '0644'

- name: Set locale for all users via profile.d
  ansible.builtin.copy:
    content: |
      # Set UTF-8 locale for all users
      export LANG={{ locale }}
      export LC_ALL={{ locale }}
    dest: /etc/profile.d/locale.sh
    mode: '0644'

# Hostname configuration
- name: Set hostname via hostname module
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"
  when: configure_hostname | bool
  register: hostname_result
  ignore_errors: true

- name: Set hostname via /etc/hostname (fallback for containers)
  ansible.builtin.copy:
    content: "{{ inventory_hostname }}\n"
    dest: /etc/hostname
    mode: '0644'
  when: configure_hostname | bool and hostname_result is failed

- name: Apply hostname immediately (fallback)
  ansible.builtin.command: hostname {{ inventory_hostname }}
  when: configure_hostname | bool and hostname_result is failed
  changed_when: true

- name: Configure /etc/hosts with FQDN
  ansible.builtin.template:
    src: hosts.j2
    dest: /etc/hosts
    mode: '0644'
    backup: true
  when: configure_hosts_file | bool

# Sudo configuration
- name: Ensure sudo is installed
  ansible.builtin.apt:
    name: sudo
    state: present
    update_cache: true
    cache_valid_time: 3600
  when: ansible_facts['os_family'] == "Debian"

- name: Configure passwordless sudo for specified users
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/{{ item }}
    line: "{{ item }} ALL=(ALL) NOPASSWD: ALL"
    create: true
    mode: '0440'
    validate: 'visudo -cf %s'
  loop: "{{ sudo_users }}"
  when: configure_sudo | bool and sudo_users | length > 0

# Static IP configuration (for systems using dhcpcd, like Raspberry Pi)
- name: Configure static IP via dhcpcd
  ansible.builtin.template:
    src: dhcpcd.conf.j2
    dest: /etc/dhcpcd.conf
    mode: '0664'
    owner: root
    group: netdev
    backup: true
  when: static_ip is defined
  notify: Restart dhcpcd
