---
# DNS Infrastructure Setup
#
# Installs and configures AdGuard Home on target hosts for DNS resolution and ad-blocking.
# Currently targets Raspberry Pi 4 as primary DNS server.
#
# Features:
# - Full IaC configuration (no manual setup wizard needed)
# - Local DNS records for paniland.com services
# - Ad blocking with standard filter lists
#
# Usage:
#   ansible-playbook ansible/playbooks/dns.yml --vault-password-file ../.vault_pass
#   ansible-playbook ansible/playbooks/dns.yml --limit pi4
#
# After running:
#   1. Test DNS: dig @192.168.1.102 google.com
#   2. Test local DNS: dig @192.168.1.102 jellyfin.paniland.com
#   3. Web UI: http://192.168.1.102:3000

- name: Configure DNS Infrastructure
  hosts: pi4:dns_containers  # Pi4 (primary) and CT310 (backup)
  become: true
  gather_facts: true

  vars_files:
    - ../vars/secrets.yml

  vars:
    # Admin credentials - password hash from vault
    # To change: python3 -c "import bcrypt; print(bcrypt.hashpw(b'your_password', bcrypt.gensalt(rounds=10)).decode())"
    adguard_home_admin_user: "cuiv"
    adguard_home_admin_password_hash: "{{ vault_adguard_admin_password_hash }}"

    # Local DNS records for homelab services
    # Pattern: *.paniland.com = service endpoints (via proxy), *.home.arpa = direct host access
    adguard_home_dns_rewrites:
      # ===========================================
      # SERVICE ENDPOINTS (via reverse proxy)
      # Use: https://service.paniland.com in browser
      # ===========================================
      - domain: "jellyfin.paniland.com"
        answer: "192.168.1.111"  # Via Caddy proxy for HTTPS
      - domain: "backrest.paniland.com"
        answer: "192.168.1.111"
      - domain: "dns.paniland.com"
        answer: "192.168.1.111"
      - domain: "proxmox.paniland.com"
        answer: "192.168.1.111"
      - domain: "unifi.paniland.com"
        answer: "192.168.1.111"
      - domain: "unifi-landing.paniland.com"
        answer: "192.168.1.111"
      - domain: "wishlist.paniland.com"
        answer: "192.168.1.111"
      - domain: "auth.paniland.com"
        answer: "192.168.1.111"  # Via Caddy proxy for HTTPS
      - domain: "lldap.paniland.com"
        answer: "192.168.1.111"  # Via Caddy proxy for HTTPS

      # ===========================================
      # HOST/MACHINE ACCESS (direct, RFC 8375)
      # Use: ssh root@host.home.arpa
      # ===========================================
      # Physical hosts
      - domain: "homelab.home.arpa"
        answer: "192.168.1.100"
      - domain: "pi3.home.arpa"
        answer: "192.168.1.101"
      - domain: "pi4.home.arpa"
        answer: "192.168.1.102"
      # Infrastructure containers
      - domain: "backup.home.arpa"
        answer: "192.168.1.120"
      - domain: "samba.home.arpa"
        answer: "192.168.1.121"
      - domain: "dns.home.arpa"
        answer: "192.168.1.110"
      - domain: "proxy.home.arpa"
        answer: "192.168.1.111"
      # Media pipeline containers
      - domain: "jellyfin.home.arpa"
        answer: "192.168.1.130"
      - domain: "ripper.home.arpa"
        answer: "192.168.1.131"
      - domain: "transcoder.home.arpa"
        answer: "192.168.1.132"
      - domain: "analyzer.home.arpa"
        answer: "192.168.1.133"
      # Personal & productivity containers
      - domain: "wishlist.home.arpa"
        answer: "192.168.1.186"
      # Security/infrastructure containers
      - domain: "authelia.home.arpa"
        answer: "192.168.1.112"
      - domain: "lldap.home.arpa"
        answer: "192.168.1.114"

    # ===========================================
    # AD BLOCKING CONFIGURATION
    # ===========================================
    # Using HaGeZi DNS Blocklists - the gold standard (16k+ GitHub stars)
    # Single consolidated list that includes 100+ source lists
    # More efficient than multiple overlapping lists
    # https://github.com/hagezi/dns-blocklists
    adguard_home_filters:
      # HaGeZi Pro - Extended protection (354k domains)
      # Includes: ads, trackers, telemetry, malware, phishing
      # Consolidates: AdGuard, AdAway, EasyList, EasyPrivacy, and 100+ more
      - enabled: true
        url: "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/pro.txt"
        name: "HaGeZi Pro DNS Blocklist"
        id: 1
      # HaGeZi Threat Intelligence Feeds - additional malware/phishing protection
      - enabled: true
        url: "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/tif.txt"
        name: "HaGeZi Threat Intelligence Feeds"
        id: 2

    # Whitelist for false positives (add as needed)
    # HaGeZi Pro is well-maintained so you may not need these
    adguard_home_user_rules:
      - "@@||s.shopify.com^"        # Shopify CDN (if blocked)
      - "@@||cdn.optimizely.com^"   # EA/Origin (if blocked)
      - "@@||split.io^"             # EA Desktop (if blocked)

    # ===========================================
    # PER-CLIENT FILTERING (EXEMPTIONS)
    # ===========================================
    # Devices that bypass ad blocking when on local network
    # Configure UniFi DHCP reservations to match these IPs
    adguard_home_persistent_clients:
      - name: "Ani's Phone"
        ids:
          - "192.168.1.32"
        filtering_enabled: false
        safebrowsing_enabled: false
        parental_enabled: false
        tags: []
      - name: "Ani's Work Laptop"
        ids:
          - "192.168.1.86"
        filtering_enabled: false
        safebrowsing_enabled: false
        parental_enabled: false
        tags: []
      # Add more devices as needed:
      # - name: "Ani's iPad"
      #   ids:
      #     - "192.168.1.xx"
      #   filtering_enabled: false

  pre_tasks:
    - name: Display target information
      ansible.builtin.debug:
        msg: |
          Setting up DNS on: {{ inventory_hostname }}
          IP: {{ ansible_host }}
          Model: {{ pi_model | default('N/A') }}

          Configuration:
          - Admin user: {{ adguard_home_admin_user }}
          - DNS rewrites: {{ adguard_home_dns_rewrites | length }} entries
          - Filter lists: {{ adguard_home_filters | default([]) | length }} lists

  roles:
    - role: common
      tags: ['common', 'base']
    - role: adguard_home
      tags: ['adguard', 'dns']

  post_tasks:
    - name: Verify AdGuard Home is running
      ansible.builtin.command: "{{ adguard_home_install_dir }}/AdGuardHome -s status"
      register: service_status
      changed_when: false

    - name: Test DNS resolution
      ansible.builtin.command: "dig @127.0.0.1 google.com +short"
      register: dns_test
      changed_when: false
      retries: 5
      delay: 3
      until: dns_test.rc == 0

    - name: Test local DNS rewrite
      ansible.builtin.command: "dig @127.0.0.1 jellyfin.paniland.com +short"
      register: local_dns_test
      changed_when: false

    - name: Display final status
      ansible.builtin.debug:
        msg: |
          DNS Infrastructure Setup Complete

          Host: {{ inventory_hostname }} ({{ ansible_host }})
          Service: {{ 'Running' if 'running' in service_status.stdout else 'Check status' }}

          DNS Resolution Test:
          - google.com: {{ dns_test.stdout_lines[0] | default('FAILED') }}
          - jellyfin.paniland.com: {{ local_dns_test.stdout | default('NOT CONFIGURED') }}

          Access:
          - Web UI: http://{{ ansible_host }}:3000
          - DNS: {{ ansible_host }}:53

          NEXT STEPS:
          1. Test from client: dig @{{ ansible_host }} jellyfin.paniland.com
          2. Update DHCP to use {{ ansible_host }} as DNS
          3. Add CT310 as backup DNS server
