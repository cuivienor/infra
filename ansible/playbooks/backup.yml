---
# Playbook to configure backup container
# Usage: ansible-playbook playbooks/backup.yml --vault-password-file ~/.vault_pass

- name: Configure backup container
  hosts: backup
  become: true

  vars_files:
    - ../vars/backup_secrets.yml

  vars:
    # Override backup user to root (simpler for container)
    backup_user: "root"
    backup_group: "root"

    # Enable pre-backup sync from service containers
    backup_sync_enabled: true

  pre_tasks:
    - name: Wait for container to be ready
      ansible.builtin.wait_for_connection:
        timeout: 60

    - name: Gather facts
      ansible.builtin.setup:

    - name: Install backup-specific packages
      ansible.builtin.apt:
        name:
          - bzip2
          - jq
        state: present

  roles:
    - role: common
      vars:
        media_user_enabled: false      # Backup runs as root
        homelab_shell_enabled: true    # Enable zsh and tools for troubleshooting
      tags: ['common', 'base']

    - role: restic_backup
      tags: ['backup', 'restic']

  post_tasks:
    - name: Read backup SSH public key
      ansible.builtin.slurp:
        src: "{{ restic_config_dir | default('/etc/restic') }}/backup_ssh_pubkey"
      register: backup_pubkey_file
      ignore_errors: true
      when: backup_sync_enabled | default(false)

    - name: Display backup container summary
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "CT300 Backup Container Configuration Complete"
          - "========================================="
          - ""
          - "Container: backup ({{ ansible_host }})"
          - "Storage mount: /mnt/storage (from host)"
          - ""
          - "Backup policy:"
          - "  - Name: data"
          - "  - Schedule: daily (3:00 AM)"
          - "  - Target: Backblaze B2 ({{ b2_bucket_data }})"
          - "  - Excludes: Movies, TV, media pipeline"
          - ""
          - "Pre-backup sync:"
          - "  - Schedule: daily (2:30 AM)"
          - "  - Syncs from: lldap, authelia, mealie, wishlist, jellyfin, caddy, vault"
          - "  - Destination: /mnt/storage/backups/"
          - ""
          - "Commands:"
          - "  Test sync: ssh backup /etc/restic/scripts/pre-backup-sync.sh"
          - "  Test backup: ssh backup systemctl start restic-backup-data.service"
          - "  View snapshots: ssh backup /etc/restic/scripts/maintenance.sh snapshots data"
          - ""
          - "========================================="

    - name: Display SSH key distribution instructions
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "IMPORTANT: Distribute backup SSH key"
          - "========================================="
          - ""
          - "Add this key to ansible/group_vars/lxc_containers.yml:"
          - ""
          - "backup_ssh_pubkey: \"{{ backup_pubkey_file.content | b64decode | trim }}\""
          - ""
          - "Then run the common role on all service containers:"
          - "  ansible-playbook playbooks/site.yml --tags ssh-keys"
          - ""
          - "Or run individual playbooks for each service."
          - "========================================="
      when: backup_sync_enabled | default(false) and backup_pubkey_file is defined and backup_pubkey_file.content is defined
