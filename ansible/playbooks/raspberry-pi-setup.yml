---
# Raspberry Pi Base Setup
#
# This playbook configures a FRESH Raspberry Pi with standard settings.
# Use this when:
# - Setting up a brand new Pi
# - After fresh OS installation
# - After running migrate-raspberry-pis.sh
#
# Prerequisites:
# - Fresh Raspberry Pi OS (Debian 12 preferred)
# - User 'cuiv' exists with sudo access
# - SSH key already deployed
#
# Run with: ansible-playbook raspberry-pi-setup.yml

- name: Configure Raspberry Pi Base System
  hosts: raspberry_pis
  become: true
  gather_facts: true

  vars:
    # Standard user configuration
    standard_user: cuiv

    # Essential packages
    base_packages:
      - vim
      - git
      - curl
      - wget
      - htop
      - tmux
      - net-tools
      - dnsutils
      - rsync
      - sudo
      - openssh-server
      - python3
      - python3-pip

    # Timezone
    system_timezone: America/Los_Angeles  # Adjust as needed

  tasks:
    # === System Information ===

    - name: Display Pi information
      ansible.builtin.debug:
        msg: |
          Configuring: {{ inventory_hostname }}
          Model: {{ pi_model }}
          OS: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_release'] }}
          User: {{ ansible_user }}
          IP: {{ ansible_facts['default_ipv4']['address'] | default(ansible_host) }}

    # === Repository Fixes ===

    - name: Fix Raspberry Pi archive repository (bullseye -> bookworm)
      ansible.builtin.replace:
        path: "{{ item }}"
        regexp: 'archive\.raspberrypi\.org/debian/?\s+bullseye'
        replace: 'archive.raspberrypi.org/debian bookworm'
      loop:
        - /etc/apt/sources.list
        - /etc/apt/sources.list.d/raspi.list
      failed_when: false
      changed_when: false

    - name: Check for legacy trusted.gpg keyring
      ansible.builtin.stat:
        path: /etc/apt/trusted.gpg
      register: legacy_keyring

    - name: Migrate legacy GPG keys to trusted.gpg.d (if needed)
      ansible.builtin.shell: |
        if [ -s /etc/apt/trusted.gpg ]; then
          apt-key exportall 2>/dev/null | gpg --dearmor > /etc/apt/trusted.gpg.d/legacy-keys.gpg
          mv /etc/apt/trusted.gpg /etc/apt/trusted.gpg.bak
        fi
      when: legacy_keyring.stat.exists and legacy_keyring.stat.size > 0
      changed_when: false
      failed_when: false

    # === System Updates ===

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Upgrade all packages
      ansible.builtin.apt:
        upgrade: full
        autoremove: true
        autoclean: true
      register: upgrade_result
      changed_when: upgrade_result.changed

    # === Essential Packages ===

    - name: Install base packages
      ansible.builtin.apt:
        name: "{{ base_packages }}"
        state: present

    # === User Configuration ===

    - name: Ensure cuiv user exists
      ansible.builtin.user:
        name: "{{ standard_user }}"
        shell: /bin/bash
        create_home: true
        groups: sudo
        append: true

    - name: Ensure cuiv has passwordless sudo
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/cuiv
        line: 'cuiv ALL=(ALL) NOPASSWD: ALL'
        create: true
        mode: '0440'
        validate: 'visudo -cf %s'

    - name: Deploy SSH key for cuiv
      ansible.posix.authorized_key:
        user: "{{ standard_user }}"
        state: present
        key: "{{ lookup('file', lookup('env', 'HOME') + '/.ssh/id_ed25519.pub') }}"

    # === System Configuration ===

    - name: Set timezone
      community.general.timezone:
        name: "{{ system_timezone }}"

    - name: Set hostname
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"

    - name: Update /etc/hosts with hostname
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1       {{ inventory_hostname }}"

    # === Disable WiFi/Bluetooth ===

    - name: Check if config.txt exists
      ansible.builtin.stat:
        path: /boot/firmware/config.txt
      register: config_txt

    - name: Disable WiFi and Bluetooth
      ansible.builtin.blockinfile:
        path: /boot/firmware/config.txt
        block: |
          # Disable WiFi and Bluetooth (Ethernet only)
          dtoverlay=disable-wifi
          dtoverlay=disable-bt
        marker: "# {mark} ANSIBLE MANAGED - DISABLE WIRELESS"
      when: config_txt.stat.exists
      notify: reboot required

    - name: Disable WiFi services
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: false
        state: stopped
      loop:
        - wpa_supplicant
      failed_when: false

    # === SSH Configuration ===

    - name: Harden SSH configuration
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
        - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
        - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
      notify: Restart ssh

    # === Automatic Security Updates ===

    - name: Install unattended-upgrades
      ansible.builtin.apt:
        name:
          - unattended-upgrades
          - apt-listchanges
        state: present

    - name: Configure automatic security updates
      ansible.builtin.copy:
        dest: /etc/apt/apt.conf.d/50unattended-upgrades
        content: |
          // Unattended-Upgrades for Raspberry Pi
          // Managed by Ansible - do not edit manually

          Unattended-Upgrade::Allowed-Origins {
              "Raspbian:stable";
              "Raspberry Pi Foundation:stable";
              "Debian:bookworm";
              "Debian:bookworm-security";
              "Debian:bookworm-updates";
              "origin=Tailscale Inc";
          };

          // Remove unused dependencies after upgrade
          Unattended-Upgrade::Remove-Unused-Dependencies "true";
          Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";

          // Don't automatically reboot (Pi is critical for DNS)
          Unattended-Upgrade::Automatic-Reboot "false";

          // Logging
          Unattended-Upgrade::SyslogEnable "true";
          Unattended-Upgrade::SyslogFacility "daemon";
        owner: root
        group: root
        mode: '0644'

    - name: Enable automatic update schedule
      ansible.builtin.copy:
        dest: /etc/apt/apt.conf.d/20auto-upgrades
        content: |
          // Automatic updates schedule
          // Managed by Ansible - do not edit manually

          APT::Periodic::Update-Package-Lists "1";
          APT::Periodic::Download-Upgradeable-Packages "1";
          APT::Periodic::Unattended-Upgrade "1";
          APT::Periodic::AutocleanInterval "7";
        owner: root
        group: root
        mode: '0644'

    - name: Verify unattended-upgrades configuration
      ansible.builtin.command: unattended-upgrade --dry-run
      register: pi_upgrade_check
      changed_when: false
      failed_when: false

    # === Cleanup ===

    - name: Remove unnecessary packages
      ansible.builtin.apt:
        autoremove: true
        autoclean: true

    - name: Clean old journal logs
      ansible.builtin.shell: journalctl --vacuum-time=7d
      changed_when: false

    # === Verification ===

    - name: Verify cuiv user
      ansible.builtin.command: id cuiv
      register: user_check
      changed_when: false

    - name: Display setup summary
      ansible.builtin.debug:
        msg: |
          {{ inventory_hostname }} configuration complete

          User: {{ standard_user }}
          SSH: Key-based authentication only
          Sudo: Passwordless for cuiv
          WiFi: Disabled (Ethernet only)
          Packages: {{ base_packages | length }} essential packages installed
          Auto-updates: Enabled (security updates only)
          Auto-reboot: Disabled (manual control for DNS stability)

  handlers:
    - name: Restart ssh
      ansible.builtin.systemd:
        name: ssh
        state: restarted

    - name: Reboot required
      ansible.builtin.debug:
        msg: "Reboot required for wireless disable to take effect"
