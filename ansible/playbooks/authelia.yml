---
# Authelia SSO Setup
#
# Deploys Authelia authentication server for centralized SSO with TOTP 2FA.
# Integrates with Caddy reverse proxy via forward_auth directive.
#
# Features:
# - Single Sign-On across all homelab services
# - LDAP backend (LLDAP) for centralized user management
# - SQLite storage backend
# - TOTP 2FA support (enrollment via web UI)
# - OIDC identity provider for OAuth applications
#
# Usage:
#   ansible-playbook ansible/playbooks/authelia.yml
#
# After running:
#   1. Add DNS rewrite: auth.paniland.com → 192.168.1.112
#   2. Navigate to https://auth.paniland.com to verify
#   3. Update Caddy with forward_auth for protected services

- name: Configure Authelia SSO
  hosts: authelia
  become: true
  gather_facts: true

  vars_files:
    - ../vars/secrets.yml

  vars:
    # Secrets from vault
    authelia_jwt_secret: "{{ vault_authelia_jwt_secret }}"
    authelia_session_secret: "{{ vault_authelia_session_secret }}"
    authelia_storage_encryption_key: "{{ vault_authelia_storage_encryption_key }}"

    # Authentication backend: ldap (via LLDAP) or file
    authelia_auth_backend: "ldap"
    authelia_ldap_user: "uid=authelia,ou=people,dc=paniland,dc=com"
    authelia_ldap_password: "{{ vault_authelia_ldap_password }}"

    # File-based user config (only used when authelia_auth_backend: file)
    authelia_users:
      - username: peter
        displayname: Peter
        email: petrov.p.peter@gmail.com
        password_hash: "{{ vault_authelia_admin_password_hash }}"
        groups:
          - admins

    # Access control rules - wishlist only for now
    authelia_access_rules:
      - domain: "wishlist.paniland.com"
        policy: "one_factor"

    # Override default policy to deny unauthenticated access
    authelia_default_policy: "deny"

    # OIDC Identity Provider configuration
    authelia_oidc_enabled: true
    authelia_oidc_hmac_secret: "{{ vault_authelia_oidc_hmac_secret }}"
    authelia_oidc_private_key: "{{ vault_authelia_oidc_private_key }}"

    # OIDC clients
    authelia_oidc_clients:
      - client_id: wishlist
        client_name: Wishlist
        client_secret: "{{ vault_authelia_oidc_wishlist_client_secret }}"
        redirect_uris:
          - https://wishlist.paniland.com/login
        scopes:
          - openid
          - profile
          - email
        authorization_policy: one_factor

    # SMTP configuration for password reset emails (via Resend)
    authelia_notifier_type: "smtp"
    authelia_smtp_address: "submissions://smtp.resend.com:465"
    authelia_smtp_username: "resend"
    authelia_smtp_password: "{{ vault_resend_api_key }}"
    authelia_smtp_sender: "Paniland Auth <auth@paniland.com>"

  pre_tasks:
    - name: Display configuration
      ansible.builtin.debug:
        msg: |
          Configuring Authelia SSO on: {{ inventory_hostname }}
          IP: {{ ansible_host }}

          Configuration:
          - Auth URL: {{ authelia_auth_url | default('https://auth.paniland.com') }}
          - Session Domain: {{ authelia_domain | default('paniland.com') }}
          - Default Policy: {{ authelia_default_policy }}
          - Users: {{ authelia_users | map(attribute='username') | list }}
          - Protected Domains:
          {% for rule in authelia_access_rules %}
            - {{ rule.domain }} ({{ rule.policy }})
          {% endfor %}

  roles:
    - role: common
      tags: ['common', 'base']
    - role: authelia
      tags: ['authelia', 'sso']

  post_tasks:
    - name: Wait for Authelia to start
      ansible.builtin.wait_for:
        port: 9091
        delay: 5
        timeout: 60

    - name: Check Authelia service status
      ansible.builtin.systemd:
        name: authelia
      register: authelia_service

    - name: Verify Authelia is running
      ansible.builtin.command: /usr/local/bin/authelia --version
      register: authelia_version
      changed_when: false

    - name: Display final status
      ansible.builtin.debug:
        msg: |
          Authelia SSO Setup Complete

          Host: {{ inventory_hostname }} ({{ ansible_host }})
          Authelia Version: {{ authelia_version.stdout }}
          Service Status: {{ authelia_service.status.ActiveState }}

          NEXT STEPS:
          1. Add DNS rewrite in AdGuard Home:
             auth.paniland.com → {{ ansible_host }}

          2. Test Authelia is accessible:
             curl -k https://auth.paniland.com

          3. Update Caddy with forward_auth for wishlist:
             ansible-playbook playbooks/proxy.yml

          4. Test authentication flow:
             - Navigate to https://wishlist.paniland.com
             - Should redirect to https://auth.paniland.com
             - Login with username: peter
