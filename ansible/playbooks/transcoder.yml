---
# Transcoder Transcoder Container Configuration
# FFmpeg with Intel Arc A380 GPU hardware acceleration

- name: Configure transcoder container
  hosts: transcoder
  become: true

  vars:
    # Enable media user creation
    media_user_enabled: true
    media_user_groups: ['video', 'render']  # For GPU access

    # SSH key deployment (only root initially, media added after user creation)
    ssh_authorized_keys_users:
      - root

    # Container ID for device passthrough
    container_id: 304

  roles:
    - role: common
      tags: ['common']

  tasks:
    - name: Deploy SSH keys for media user
      ansible.posix.authorized_key:
        user: media
        key: "{{ lookup('file', '../files/ssh-keys/laptop.pub') }}"
        state: present
      tags: ['ssh-keys']

    - name: Install FFmpeg and VA-API packages
      ansible.builtin.apt:
        name:
          - ffmpeg
          - vainfo
          - intel-media-va-driver
          - mesa-va-drivers
        state: present
        update_cache: true
      tags: ['ffmpeg']

    - name: Create scripts directory for media user
      ansible.builtin.file:
        path: /home/media/scripts
        state: directory
        owner: media
        group: media
        mode: '0755'
      tags: ['scripts']

    - name: Deploy transcode scripts
      ansible.builtin.copy:
        src: "{{ item.src }}"
        dest: "/home/media/scripts/{{ item.dest }}"
        owner: media
        group: media
        mode: '0755'
      loop:
        - { src: "../../scripts/media/production/transcode.sh", dest: "transcode.sh" }
        - { src: "../../scripts/media/utilities/run-bg.sh", dest: "run-bg.sh" }
        # Legacy script (keeping for reference, can be removed later)
        - { src: "../../scripts/media/production/transcode-queue.sh", dest: "transcode-queue.sh" }
      tags: ['scripts']

    - name: Remove old STAGING_BASE environment variable
      ansible.builtin.lineinfile:
        path: /home/media/.bashrc
        line: 'export STAGING_BASE="/mnt/staging"'
        state: absent
        owner: media
        group: media
      tags: ['scripts']

    - name: Add Intel GPU environment variables for VA-API
      ansible.builtin.lineinfile:
        path: /home/media/.bashrc
        line: "{{ item }}"
        state: present
        owner: media
        group: media
      loop:
        - 'export LIBVA_DRIVER_NAME=iHD'
        - 'export LIBVA_DRIVERS_PATH=/usr/lib/x86_64-linux-gnu/dri'
      tags: ['ffmpeg']

# GPU passthrough must run on the Proxmox host
- name: Configure Intel GPU passthrough
  hosts: homelab
  become: true

  vars:
    container_id: 304

  roles:
    - role: intel_gpu_passthrough
      tags: ['gpu', 'passthrough']

# Verification tasks (run after container restart)
- name: Verify transcoder container configuration
  hosts: transcoder
  become: true

  tasks:
    - name: Wait for container to be ready after restart
      ansible.builtin.wait_for_connection:
        timeout: 60
      tags: ['verify']

    - name: Verify GPU devices exist
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - /dev/dri/card1
        - /dev/dri/renderD128
      register: gpu_devices
      tags: ['verify']

    - name: Display GPU device status
      ansible.builtin.debug:
        msg: "{{ item.item }} {{ 'exists' if item.stat.exists else 'MISSING' }}"
      loop: "{{ gpu_devices.results }}"
      tags: ['verify']

    - name: Check media user GPU group membership
      ansible.builtin.command: groups media
      register: media_groups
      changed_when: false
      tags: ['verify']

    - name: Display media user groups
      ansible.builtin.debug:
        msg: "{{ media_groups.stdout }}"
      tags: ['verify']

    - name: Test VA-API access
      ansible.builtin.command: vainfo --display drm --device /dev/dri/renderD128
      register: vainfo_test
      failed_when: false
      changed_when: false
      become_user: media
      tags: ['verify']

    - name: Display VA-API test result
      ansible.builtin.debug:
        msg: "{{ vainfo_test.stdout_lines[0:10] }}"
      when: vainfo_test.stdout_lines is defined and vainfo_test.stdout_lines | length > 0
      tags: ['verify']

    - name: Verify FFmpeg can detect hardware encoders
      ansible.builtin.shell: ffmpeg -hide_banner -encoders 2>&1 | grep -E "(h264_vaapi|hevc_vaapi)"
      register: ffmpeg_encoders
      failed_when: false
      changed_when: false
      become_user: media
      tags: ['verify']

    - name: Display FFmpeg hardware encoder status
      ansible.builtin.debug:
        msg: "{{ ffmpeg_encoders.stdout_lines }}"
      when: ffmpeg_encoders.stdout_lines is defined and ffmpeg_encoders.stdout_lines | length > 0
      tags: ['verify']

    - name: Verify scripts deployed
      ansible.builtin.stat:
        path: "/home/media/scripts/{{ item }}"
      loop:
        - transcode.sh
        - run-bg.sh
      register: script_checks
      tags: ['verify']

    - name: Display script deployment status
      ansible.builtin.debug:
        msg: "{{ item.item }}: {{ 'OK' if item.stat.exists else 'MISSING' }}"
      loop: "{{ script_checks.results }}"
      tags: ['verify']

    - name: Verify media mount exists
      ansible.builtin.stat:
        path: /mnt/media/staging/2-remuxed
      register: staging_mount
      tags: ['verify']

    - name: Display media mount status
      ansible.builtin.debug:
        msg: "Media staging directory {{ 'mounted correctly' if staging_mount.stat.exists else 'MISSING - check mount configuration' }}"
      tags: ['verify']

    - name: Summary of verification
      ansible.builtin.debug:
        msg:
          - "==================================="
          - "Transcoder Container Verification Summary"
          - "==================================="
          - "GPU devices: {{ gpu_devices.results | selectattr('stat.exists') | list | length }}/2"
          - "Scripts deployed: {{ script_checks.results | selectattr('stat.exists') | list | length }}/2"
          - "Media mount: {{ 'OK' if staging_mount.stat.exists else 'FAIL' }}"
          - ""
          - "Next steps:"
          - "1. Test with: ssh media@transcoder.home.arpa"
          - "2. Transcode TV: ~/scripts/transcode.sh -t show -n 'Show Name' -s 1"
          - "3. Transcode Movie: ~/scripts/transcode.sh -t movie -n 'Movie Name'"
      tags: ['verify']
