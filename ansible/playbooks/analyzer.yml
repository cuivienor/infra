---
# Analyzer Analyzer Container Configuration
# Media analysis, remuxing, and organization tools

- name: Configure analyzer container
  hosts: analyzer
  become: true

  vars:
    # Enable media user creation
    media_user_enabled: true
    # No special groups needed for analyzer (no hardware passthrough)
    media_user_groups: []

    # SSH key deployment
    ssh_authorized_keys_users:
      - root
      - media  # Allow direct SSH as media user

    # Optional: Enable FileBot installation
    # Set to true if you want automated FileBot organization
    media_analyzer_install_filebot: true

  roles:
    - role: common
      tags: ['common']

    - role: media_analyzer
      tags: ['analyzer', 'media']

# Verification tasks
- name: Verify analyzer container configuration
  hosts: analyzer
  become: true

  tasks:
    - name: Wait for container to be ready
      ansible.builtin.wait_for_connection:
        timeout: 30
      tags: ['verify']

    - name: Verify staging mount exists
      ansible.builtin.stat:
        path: /mnt/staging/1-ripped
      register: staging_mount
      tags: ['verify']

    - name: Display staging mount status
      ansible.builtin.debug:
        msg: "Staging directory {{ 'mounted correctly' if staging_mount.stat.exists else 'MISSING - check mount configuration' }}"
      tags: ['verify']

    - name: Verify scripts are deployed
      ansible.builtin.stat:
        path: "/home/media/scripts/{{ item }}"
      loop:
        - analyze-media.sh
        - remux.sh
        - filebot-process.sh
        - run-bg.sh
      register: script_checks
      tags: ['verify']

    - name: Display script deployment status
      ansible.builtin.debug:
        msg: "{{ item.item }}: {{ 'OK' if item.stat.exists else 'MISSING' }}"
      loop: "{{ script_checks.results }}"
      tags: ['verify']

    - name: Test analyze-media.sh script
      ansible.builtin.command: /home/media/scripts/analyze-media.sh
      register: script_test
      failed_when: false
      changed_when: false
      become_user: media
      tags: ['verify']

    - name: Display script test result
      ansible.builtin.debug:
        msg: "analyze-media.sh {{ 'works correctly' if script_test.rc == 1 else 'has issues' }}"
      tags: ['verify']

    - name: Verify tools are installed
      ansible.builtin.command: "{{ item.cmd }}"
      loop:
        - { cmd: "mkvmerge --version", name: "mkvtoolnix" }
        - { cmd: "mediainfo --version", name: "mediainfo" }
        - { cmd: "jq --version", name: "jq" }
      register: tool_checks
      changed_when: false
      failed_when: false
      tags: ['verify']

    - name: Display tool installation status
      ansible.builtin.debug:
        msg: "{{ item.item.name }}: {{ 'INSTALLED' if item.rc == 0 else 'MISSING' }}"
      loop: "{{ tool_checks.results }}"
      tags: ['verify']

    - name: Summary of verification
      ansible.builtin.debug:
        msg:
          - "==================================="
          - "Analyzer Container Verification Summary"
          - "==================================="
          - "Staging mount: {{ 'OK' if staging_mount.stat.exists else 'FAIL' }}"
          - "Scripts deployed: {{ script_checks.results | selectattr('stat.exists') | list | length }}/4"
          - "Tools installed: {{ tool_checks.results | selectattr('rc', 'equalto', 0) | list | length }}/3"
          - ""
          - "Next steps:"
          - "1. Test with: ssh media@analyzer.home.arpa"
          - "2. Analyze: ~/scripts/analyze-media.sh /mnt/media/staging/1-ripped/movies/<folder>/"
          - "3. Remux TV: ~/scripts/remux.sh -t show -n 'Show Name' -s 1"
          - "4. Remux Movie: ~/scripts/remux.sh -t movie -n 'Movie Name'"
      tags: ['verify']
