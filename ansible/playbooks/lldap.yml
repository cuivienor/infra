---
# LLDAP Setup
#
# Deploys LLDAP - a lightweight LDAP server for centralized user management.
# Provides LDAP authentication backend for Authelia and other services.
#
# Features:
# - Lightweight (~10MB RAM)
# - Web UI for user management at http://lldap:17170
# - LDAP protocol on port 3890
# - GraphQL API for programmatic access
#
# Usage:
#   ansible-playbook ansible/playbooks/lldap.yml
#
# After running:
#   1. Access web UI at http://192.168.1.114:17170
#   2. Login with admin credentials
#   3. Configure terraform/lldap/ to manage users
#   4. Update Authelia to use LDAP backend

- name: Configure LLDAP
  hosts: lldap
  become: true
  gather_facts: true

  vars_files:
    - ../vars/secrets.yml

  vars:
    # Secrets from vault
    lldap_admin_password: "{{ vault_lldap_admin_password }}"
    lldap_jwt_secret: "{{ vault_lldap_jwt_secret }}"
    lldap_key_seed: "{{ vault_lldap_key_seed }}"

    # HTTP URL for web UI (used in password reset emails if SMTP enabled)
    lldap_http_url: "http://192.168.1.114:17170"

  pre_tasks:
    - name: Display configuration
      ansible.builtin.debug:
        msg: |
          Configuring LLDAP on: {{ inventory_hostname }}
          IP: {{ ansible_host }}

          Configuration:
          - LDAP Port: {{ lldap_ldap_port | default(3890) }}
          - HTTP Port: {{ lldap_http_port | default(17170) }}
          - Base DN: {{ lldap_base_dn | default('dc=paniland,dc=com') }}
          - Admin User: {{ lldap_admin_username | default('admin') }}

  roles:
    - role: common
      tags: ['common', 'base']
    - role: lldap
      tags: ['lldap', 'ldap']

  post_tasks:
    - name: Wait for LLDAP LDAP port
      ansible.builtin.wait_for:
        port: "{{ lldap_ldap_port | default(3890) }}"
        delay: 5
        timeout: 60

    - name: Wait for LLDAP HTTP port
      ansible.builtin.wait_for:
        port: "{{ lldap_http_port | default(17170) }}"
        delay: 2
        timeout: 30

    - name: Check LLDAP service status
      ansible.builtin.systemd:
        name: lldap
      register: lldap_service

    - name: Display final status
      ansible.builtin.debug:
        msg: |
          LLDAP Setup Complete

          Host: {{ inventory_hostname }} ({{ ansible_host }})
          Service Status: {{ lldap_service.status.ActiveState }}

          Endpoints:
          - Web UI: http://{{ ansible_host }}:17170
          - LDAP: ldap://{{ ansible_host }}:3890
          - GraphQL API: http://{{ ansible_host }}:17170/api/graphql

          NEXT STEPS:
          1. Access web UI and login with admin credentials

          2. Configure Terraform to manage users:
             cd terraform/lldap && terraform init && terraform apply

          3. Update Authelia to use LDAP backend:
             ansible-playbook playbooks/authelia.yml
