---
# CT304 Transcoder Container Configuration
# FFmpeg with Intel Arc A380 GPU hardware acceleration

- name: Configure transcoder container
  hosts: ct304
  become: yes
  
  vars:
    # Enable media user creation
    media_user_enabled: true
    media_user_groups: ['video', 'render']  # For GPU access
    
    # SSH key deployment (only root initially, media added after user creation)
    ssh_authorized_keys_users:
      - root
    
    # Container ID for device passthrough
    container_id: 304

  roles:
    - role: common
      tags: ['common']

  tasks:
    - name: Deploy SSH keys for media user
      ansible.builtin.authorized_key:
        user: media
        key: "{{ lookup('file', '../files/ssh-keys/laptop.pub') }}"
        state: present
      tags: ['ssh-keys']

    - name: Install FFmpeg and VA-API packages
      apt:
        name:
          - ffmpeg
          - vainfo
          - intel-media-va-driver
          - mesa-va-drivers
        state: present
        update_cache: yes
      tags: ['ffmpeg']

    - name: Create scripts directory for media user
      file:
        path: /home/media/scripts
        state: directory
        owner: media
        group: media
        mode: '0755'
      tags: ['scripts']

    - name: Deploy transcode scripts
      copy:
        src: "{{ item.src }}"
        dest: "/home/media/scripts/{{ item.dest }}"
        owner: media
        group: media
        mode: '0755'
      loop:
        - { src: "../../scripts/media/production/transcode-queue.sh", dest: "transcode-queue.sh" }
        - { src: "../../scripts/media/utilities/run-bg.sh", dest: "run-bg.sh" }
      tags: ['scripts']

    - name: Configure staging path environment variable
      lineinfile:
        path: /home/media/.bashrc
        line: 'export STAGING_BASE="/mnt/staging"'
        state: present
        owner: media
        group: media
      tags: ['scripts']

    - name: Add Intel GPU environment variables for VA-API
      lineinfile:
        path: /home/media/.bashrc
        line: "{{ item }}"
        state: present
        owner: media
        group: media
      loop:
        - 'export LIBVA_DRIVER_NAME=iHD'
        - 'export LIBVA_DRIVERS_PATH=/usr/lib/x86_64-linux-gnu/dri'
      tags: ['ffmpeg']

# GPU passthrough must run on the Proxmox host
- name: Configure Intel GPU passthrough
  hosts: homelab
  become: yes
  
  vars:
    container_id: 304
  
  roles:
    - role: intel_gpu_passthrough
      tags: ['gpu', 'passthrough']

# Verification tasks (run after container restart)
- name: Verify transcoder container configuration
  hosts: ct304
  become: yes
  
  tasks:
    - name: Wait for container to be ready after restart
      wait_for_connection:
        timeout: 60
      tags: ['verify']

    - name: Verify GPU devices exist
      stat:
        path: "{{ item }}"
      loop:
        - /dev/dri/card1
        - /dev/dri/renderD128
      register: gpu_devices
      tags: ['verify']

    - name: Display GPU device status
      debug:
        msg: "{{ item.item }} {{ 'exists' if item.stat.exists else 'MISSING' }}"
      loop: "{{ gpu_devices.results }}"
      tags: ['verify']

    - name: Check media user GPU group membership
      command: groups media
      register: media_groups
      changed_when: false
      tags: ['verify']

    - name: Display media user groups
      debug:
        msg: "{{ media_groups.stdout }}"
      tags: ['verify']

    - name: Test VA-API access
      command: vainfo --display drm --device /dev/dri/renderD128
      register: vainfo_test
      failed_when: false
      changed_when: false
      become_user: media
      tags: ['verify']

    - name: Display VA-API test result
      debug:
        msg: "{{ vainfo_test.stdout_lines[0:10] }}"
      when: vainfo_test.stdout_lines is defined and vainfo_test.stdout_lines | length > 0
      tags: ['verify']

    - name: Verify FFmpeg can detect hardware encoders
      shell: ffmpeg -hide_banner -encoders 2>&1 | grep -E "(h264_vaapi|hevc_vaapi)"
      register: ffmpeg_encoders
      failed_when: false
      changed_when: false
      become_user: media
      tags: ['verify']

    - name: Display FFmpeg hardware encoder status
      debug:
        msg: "{{ ffmpeg_encoders.stdout_lines }}"
      when: ffmpeg_encoders.stdout_lines is defined and ffmpeg_encoders.stdout_lines | length > 0
      tags: ['verify']

    - name: Verify scripts deployed
      stat:
        path: /home/media/scripts/transcode-queue.sh
      register: script_check
      tags: ['verify']

    - name: Display script deployment status
      debug:
        msg: "transcode-queue.sh {{ 'deployed successfully' if script_check.stat.exists else 'MISSING' }}"
      tags: ['verify']

    - name: Verify staging mount exists
      stat:
        path: /mnt/staging/2-remuxed
      register: staging_mount
      tags: ['verify']

    - name: Display staging mount status
      debug:
        msg: "Staging directory {{ 'mounted correctly' if staging_mount.stat.exists else 'MISSING - check mount configuration' }}"
      tags: ['verify']
